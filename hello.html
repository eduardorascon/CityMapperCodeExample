<html>
    <head>
        <style>
            #map {
                height: 100%;
            }
        </style>
        <title>{{ title }}</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function() {
                initMap();
                initMarkers();
            });

            var map;
            function initMap(){
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat:19.4057, lng:-99.1488 },
                    zoom: 13
                });

                google.maps.event.addListener(map, 'click', function(event){
                    placeMarker(event.latLng);
                });
            }

            function calculateDistance(fromMarker, toMarker) {
                if(fromMarker ==  null || toMarker == null)
                    return;

                var distance = google.maps.geometry.spherical.computeDistanceBetween(fromMarker.getPosition(), toMarker.getPosition());
                return distance;
            };

            function displayNearbyMarkers(marker){
                $.each(station_markers, function(index, data){
                    var distance = calculateDistance(marker, station_markers[index]);
                    if(distance <= 160){
                        station_markers[index].setMap(map);
                    }
                });
            }

            var start_marker, end_marker;
            function placeMarker(location) {
                if(start_marker != null && end_marker != null)
                    return;

                var marker = new google.maps.Marker({
                    position: location,
                    draggable: true,
                    map: map
                });

                displayNearbyMarkers(marker);

                google.maps.event.addListener(marker, 'dragend', function(event){
                    displayNearbyMarkers(marker);
                });

                if(start_marker == null){
                    start_marker = marker;
                    start_marker.setIcon('http://maps.google.com/mapfiles/ms/icons/yellow-dot.png');
                    return;
                }
                else{
                    if(end_marker == null){
                        end_marker = marker;
                    }
                    else{
                        start_marker.setMap(null);
                        start_marker = end_marker;
                        end_marker = marker;
                    }
                    start_marker.setIcon('http://maps.google.com/mapfiles/ms/icons/yellow-dot.png');
                    end_marker.setIcon('http://maps.google.com/mapfiles/ms/icons/red-dot.png');
                }
            }

            var station_markers = [];
            function initMarkers () {
                $.ajax({
                    type:"POST",
                    url:"/ecobici",
                    dataType: "json"
                })
                .done(function(data) {
                    var lat, lon;
                    $.each(data["stations"], function(index, data) {
                        lat = (data["location"])["lat"];
                        lon = (data["location"])["lon"];
                        var marker = new google.maps.Marker({
                            position: new google.maps.LatLng(lat, lon),
                            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                            //animation: google.maps.Animation.DROP,
                            //map: map
                        });
                        station_markers.push(marker);
                    });
                });
            }
        </script>
    </head>
<body>
    <div id="map"></div>
    <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry&key=AIzaSyDO-JpX5xstJy9SzL630GoK3HLUUudYtNI" async defer></script>
</body>
</html>