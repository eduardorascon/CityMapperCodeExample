<html>
    <head>
        <style>
            #map {
                height: 100%;
            }
        </style>
        <title>{{ title }}</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function() {
                initMarkers();
                initMap();
            });

            var map;
            function initMap(){
                map = new google.maps.Map(document.getElementById('map'), {
                    center: { lat:19.4057, lng:-99.1488 },
                    zoom: 13
                });

                google.maps.event.addListener(map, 'click', function(event){
                    placeMarker(event.latLng);
                });
            }

            function calculateDistance(fromMarker, toMarker) {
                if(fromMarker ==  null || toMarker == null)
                    return;

                return google.maps.geometry.spherical.computeDistanceBetween(fromMarker.getPosition(), toMarker.getPosition());;
            };

            var nearby_from_start_marker, nearby_from_end_marker;
            function displayNearbyMarkers(marker){
                hideLastNearbyMarkers(marker);

                var nearby_markers = []
                var distance;
                $.each(station_markers, function(index, data){
                    distance = calculateDistance(marker, station_markers[index]);
                    if(distance <= 180){
                        station_markers[index].setMap(map);
                        nearby_markers.push(station_markers[index]);
                    }
                });

                if(marker === start_marker){ 
                    nearby_from_start_marker = nearby_markers;
                }
                else{
                    nearby_from_end_marker = nearby_markers;
                }

                marker.setZIndex(google.maps.Marker.MAX_ZINDEX + 1);
            }

            function hideLastNearbyMarkers(marker){
                var markers = (marker == start_marker ? nearby_from_start_marker : nearby_from_end_marker);

                if(markers == null)
                    return;

                $.each(markers, function(index, data){
                    markers[index].setMap(null);
                });
            }

            //Lets place a start and an end marker.
            var start_marker, end_marker;
            function placeMarker(location) {

                //if start and end marker are set lets remove 'click' listener from map
                if(end_marker != null){
                    google.maps.event.clearListeners(map, 'click');
                    return;
                }

                var marker = new google.maps.Marker({
                    position: location,
                    draggable: true,
                    icon: 'http://maps.google.com/mapfiles/ms/icons/' + (start_marker == null ? 'yellow-dot.png' : 'red-dot.png'),
                    map: map
                });

                google.maps.event.addListener(marker, 'dragend', function(event){
                    displayNearbyMarkers(marker);
                });

                if(start_marker == null) {
                    start_marker = marker;
                }
                else {
                    end_marker = marker;
                }

                displayNearbyMarkers(marker);
            }

            var station_markers = [];
            function initMarkers () {
                $.ajax({
                    type:"POST",
                    url:"/ecobici",
                    dataType: "json"
                })
                .done(function(data) {
                    var lat, lon;
                    $.each(data["stations"], function(index, data) {
                        lat = (data["location"])["lat"];
                        lon = (data["location"])["lon"];
                        var marker = new google.maps.Marker({
                            position: new google.maps.LatLng(lat, lon),
                            icon: 'http://maps.google.com/mapfiles/ms/icons/green-dot.png'
                            //animation: google.maps.Animation.DROP,
                            //map: map
                        });
                        station_markers.push(marker);
                    });
                });
            }
        </script>
    </head>
<body>
    <div id="map"></div>
    <script src="https://maps.googleapis.com/maps/api/js?libraries=geometry&key=AIzaSyDO-JpX5xstJy9SzL630GoK3HLUUudYtNI" async defer></script>
</body>
</html>